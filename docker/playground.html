<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sticky-overseer playground</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0d1117;
      --surface: #161b22;
      --border:  #30363d;
      --accent:  #58a6ff;
      --green:   #3fb950;
      --yellow:  #d29922;
      --red:     #f85149;
      --muted:   #8b949e;
      --text:    #e6edf3;
      --mono:    'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    header h1 { font-size: 16px; font-weight: 600; letter-spacing: .02em; }
    header h1 span { color: var(--accent); }

    .conn-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .conn-bar input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 13px;
      width: 240px;
    }
    .conn-bar input:focus { outline: none; border-color: var(--accent); }

    button {
      background: var(--accent);
      color: #0d1117;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    button:hover { opacity: .85; }
    button:disabled { opacity: .4; cursor: default; }
    button.danger { background: var(--red); color: #fff; }
    button.secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    button.secondary:hover { border-color: var(--accent); color: var(--accent); }

    .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--muted);
      transition: background .3s;
      flex-shrink: 0;
    }
    .dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot.connecting { background: var(--yellow); }
    .dot.error { background: var(--red); }

    /* ── Layout ── */
    main {
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: 1fr;
      flex: 1;
      overflow: hidden;
    }

    /* ── Left panel ── */
    .left-panel {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .tab {
      padding: 10px 16px;
      font-size: 13px;
      cursor: pointer;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: color .15s;
      user-select: none;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab-content {
      display: none;
      flex-direction: column;
      overflow-y: auto;
      flex: 1;
      padding: 16px;
      gap: 16px;
    }
    .tab-content.active { display: flex; }

    /* ── Operation cards ── */
    .op-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .op-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      user-select: none;
    }
    .op-card-header:hover { background: rgba(88,166,255,.06); }

    .method-badge {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
      letter-spacing: .05em;
      font-family: var(--mono);
    }
    .method-badge.send  { background: #1f4068; color: #58a6ff; }
    .method-badge.recv  { background: #1a3a2a; color: #3fb950; }

    .op-title { font-weight: 500; font-size: 13px; }
    .op-desc  { font-size: 12px; color: var(--muted); margin-left: auto; }

    .chevron { margin-left: 4px; color: var(--muted); transition: transform .2s; }
    .op-card.expanded .chevron { transform: rotate(90deg); }

    .op-body { display: none; padding: 14px; border-top: 1px solid var(--border); }
    .op-card.expanded .op-body { display: block; }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      margin-top: 10px;
    }
    label:first-child { margin-top: 0; }

    input[type=text], textarea, select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-family: var(--mono);
    }
    input[type=text]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }
    textarea { resize: vertical; min-height: 70px; }

    .send-btn-row {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .hint { font-size: 11px; color: var(--muted); margin-top: 6px; }

    /* ── Tasks panel ── */
    .tasks-list { display: flex; flex-direction: column; gap: 10px; }

    .task-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
    }
    .task-card-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .task-state {
      font-size: 11px;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 4px;
    }
    .task-state.active  { background: #1f4068; color: var(--accent); }
    .task-state.stopped { background: #2a2020; color: var(--muted); }
    .task-state.errored { background: #3a1a1a; color: var(--red); }

    .task-cmd { font-family: var(--mono); font-size: 12px; color: var(--text); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .task-id  { font-family: var(--mono); font-size: 10px; color: var(--muted); }

    .task-actions { display: flex; gap: 6px; margin-top: 8px; }
    .task-actions button { font-size: 11px; padding: 3px 10px; }

    /* ── Raw message panel ── */
    .raw-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .raw-area textarea { min-height: 120px; }

    /* ── Right panel – event log ── */
    .right-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .log-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .log-header h2 { font-size: 13px; font-weight: 600; }

    .filter-row {
      display: flex;
      gap: 6px;
      flex: 1;
    }
    .filter-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      background: transparent;
      color: var(--muted);
      font-weight: 500;
      transition: all .15s;
    }
    .filter-chip:hover { color: var(--text); }
    .filter-chip.on { border-color: var(--accent); color: var(--accent); background: rgba(88,166,255,.1); }

    #log {
      flex: 1;
      overflow-y: auto;
      font-family: var(--mono);
      font-size: 12px;
      padding: 10px 0;
    }

    .log-entry {
      display: flex;
      gap: 10px;
      padding: 3px 16px;
      border-bottom: 1px solid rgba(48,54,61,.4);
      line-height: 1.5;
    }
    .log-entry:hover { background: rgba(88,166,255,.04); }

    .log-ts    { color: var(--muted); flex-shrink: 0; font-size: 11px; padding-top: 1px; }
    .log-dir   { flex-shrink: 0; font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 3px; align-self: flex-start; margin-top: 1px; }
    .log-dir.tx { background: rgba(88,166,255,.15); color: var(--accent); }
    .log-dir.rx { background: rgba(63,185,80,.15);  color: var(--green); }
    .log-dir.sys { background: rgba(210,153,34,.15); color: var(--yellow); }

    .log-type  { flex-shrink: 0; color: var(--yellow); min-width: 80px; }
    .log-body  { color: var(--text); word-break: break-all; flex: 1; }
    .log-body .output-data { color: #c9d1d9; }
    .log-body .output-data.stderr { color: #ffa657; }
    .log-body .task-id-ref { color: var(--muted); font-size: 10px; }
    .log-body .pid-ref     { color: #a5d6ff; }

    .log-entry.hidden { display: none; }

    .empty-log {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      gap: 8px;
    }
    .empty-log svg { opacity: .3; }
    .empty-log p { font-size: 13px; }

    /* scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .tag { font-size: 10px; color: var(--muted); font-style: italic; }

    .status-bar {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 4px 16px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 16px;
      flex-shrink: 0;
    }
    .status-bar span b { color: var(--text); }
  </style>
</head>
<body>

<header>
  <h1>sticky<span>-overseer</span> <span class="tag">playground</span></h1>
  <div class="conn-bar">
    <div class="dot" id="dot"></div>
    <input type="text" id="wsUrl" value="ws://localhost:8080/ws" placeholder="ws://host:port/ws">
    <button id="connectBtn" onclick="toggleConnect()">Connect</button>
  </div>
</header>

<main>
  <!-- ── Left panel ── -->
  <div class="left-panel">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('operations')">Operations</div>
      <div class="tab" onclick="switchTab('tasks')">Tasks <span id="taskCount" style="color:var(--muted);font-size:11px"></span></div>
      <div class="tab" onclick="switchTab('raw')">Raw</div>
    </div>

    <!-- Operations tab -->
    <div class="tab-content active" id="tab-operations">

      <!-- start -->
      <div class="op-card expanded" id="card-start">
        <div class="op-card-header" onclick="toggleCard('card-start')">
          <span class="method-badge send">SEND</span>
          <span class="op-title">start</span>
          <span class="op-desc">Spawn a process</span>
          <span class="chevron">›</span>
        </div>
        <div class="op-body">
          <label>task_id <span class="hint" style="display:inline">(leave blank to auto-generate)</span></label>
          <input type="text" id="start-taskid" placeholder="auto">

          <label>command</label>
          <input type="text" id="start-command" placeholder="/bin/sh" value="/bin/sh">

          <label>args <span class="hint" style="display:inline">(space-separated)</span></label>
          <input type="text" id="start-args" placeholder='-c "echo hello; sleep 2"' value='-c "while true; do date; sleep 2; done"'>

          <label>retry_policy</label>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div>
              <div class="hint">restart_delay</div>
              <input type="text" id="start-restart-delay" placeholder="5s">
            </div>
            <div>
              <div class="hint">error_window</div>
              <input type="text" id="start-error-window" placeholder="1m">
            </div>
            <div>
              <div class="hint">error_threshold</div>
              <input type="text" id="start-error-threshold" placeholder="3">
            </div>
          </div>

          <div class="send-btn-row">
            <button onclick="sendStart()">Send start</button>
            <span class="hint" id="start-hint"></span>
          </div>
        </div>
      </div>

      <!-- list -->
      <div class="op-card" id="card-list">
        <div class="op-card-header" onclick="toggleCard('card-list')">
          <span class="method-badge send">SEND</span>
          <span class="op-title">list</span>
          <span class="op-desc">Query tasks</span>
          <span class="chevron">›</span>
        </div>
        <div class="op-body">
          <label>since <span class="hint" style="display:inline">(RFC3339, optional)</span></label>
          <input type="text" id="list-since" placeholder="2024-01-01T00:00:00Z">
          <div class="send-btn-row">
            <button onclick="sendList()">Send list</button>
            <button class="secondary" onclick="sendList(true)">List + refresh panel</button>
          </div>
        </div>
      </div>

      <!-- stop -->
      <div class="op-card" id="card-stop">
        <div class="op-card-header" onclick="toggleCard('card-stop')">
          <span class="method-badge send">SEND</span>
          <span class="op-title">stop</span>
          <span class="op-desc">SIGTERM → SIGKILL</span>
          <span class="chevron">›</span>
        </div>
        <div class="op-body">
          <label>task_id</label>
          <input type="text" id="stop-taskid" placeholder="uuid">
          <div class="send-btn-row">
            <button class="danger" onclick="sendStop()">Send stop</button>
          </div>
        </div>
      </div>

      <!-- reset -->
      <div class="op-card" id="card-reset">
        <div class="op-card-header" onclick="toggleCard('card-reset')">
          <span class="method-badge send">SEND</span>
          <span class="op-title">reset</span>
          <span class="op-desc">Clear errored state</span>
          <span class="chevron">›</span>
        </div>
        <div class="op-body">
          <label>task_id</label>
          <input type="text" id="reset-taskid" placeholder="uuid">
          <div class="send-btn-row">
            <button onclick="sendReset()">Send reset</button>
          </div>
        </div>
      </div>

      <!-- replay -->
      <div class="op-card" id="card-replay">
        <div class="op-card-header" onclick="toggleCard('card-replay')">
          <span class="method-badge send">SEND</span>
          <span class="op-title">replay</span>
          <span class="op-desc">Ring buffer replay</span>
          <span class="chevron">›</span>
        </div>
        <div class="op-body">
          <label>task_id</label>
          <input type="text" id="replay-taskid" placeholder="uuid">
          <label>since <span class="hint" style="display:inline">(RFC3339, optional)</span></label>
          <input type="text" id="replay-since" placeholder="2024-01-01T00:00:00Z">
          <div class="send-btn-row">
            <button onclick="sendReplay()">Send replay</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Tasks tab -->
    <div class="tab-content" id="tab-tasks">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="secondary" onclick="sendList(true)" style="flex:1">Refresh tasks</button>
        <button class="secondary" onclick="clearTasks()">Clear</button>
      </div>
      <div class="tasks-list" id="tasksList">
        <div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">
          No tasks yet. Send a <b>list</b> or <b>start</b>.
        </div>
      </div>
    </div>

    <!-- Raw tab -->
    <div class="tab-content" id="tab-raw">
      <div class="raw-area">
        <div>
          <label>Raw JSON message</label>
          <textarea id="rawMsg" placeholder='{"type":"list"}'></textarea>
          <div class="hint">Paste any valid IncomingMessage JSON and send directly.</div>
        </div>
        <div class="send-btn-row">
          <button onclick="sendRaw()">Send raw</button>
          <button class="secondary" onclick="formatRaw()">Format</button>
        </div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>
          <label>Presets</label>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="secondary" onclick="loadPreset('list')">list (all tasks)</button>
            <button class="secondary" onclick="loadPreset('start-echo')">start echo loop</button>
            <button class="secondary" onclick="loadPreset('start-retry')">start with retry policy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Right panel ── -->
  <div class="right-panel">
    <div class="log-header">
      <h2>Event Log</h2>
      <div class="filter-row" id="filters">
        <span class="filter-chip on" data-type="output"   onclick="toggleFilter(this)">output</span>
        <span class="filter-chip on" data-type="started"  onclick="toggleFilter(this)">started</span>
        <span class="filter-chip on" data-type="exited"   onclick="toggleFilter(this)">exited</span>
        <span class="filter-chip on" data-type="tasks"    onclick="toggleFilter(this)">tasks</span>
        <span class="filter-chip on" data-type="error"    onclick="toggleFilter(this)">error</span>
        <span class="filter-chip on" data-type="other"    onclick="toggleFilter(this)">other</span>
      </div>
      <button class="secondary" onclick="clearLog()" style="font-size:11px;padding:3px 10px">Clear</button>
      <label style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--muted);margin:0;cursor:pointer">
        <input type="checkbox" id="autoScroll" checked> auto-scroll
      </label>
    </div>

    <div id="log">
      <div class="empty-log">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
          <polyline points="13 2 13 9 20 9"/>
        </svg>
        <p>Connect and send messages to see events here.</p>
      </div>
    </div>

    <div class="status-bar">
      <span>Messages: <b id="msgCount">0</b></span>
      <span>Sent: <b id="sentCount">0</b></span>
      <span>Tasks tracked: <b id="taskCountStatus">0</b></span>
      <span id="lastMsg"></span>
    </div>
  </div>
</main>

<script>
// ── State ──
let ws = null;
let msgCount = 0, sentCount = 0;
let tasks = {};          // task_id → TaskInfo
let activeFilters = new Set(['output','started','exited','tasks','error','other']);
let logEmpty = true;
let reqId = 0;
const pendingRequests = {};  // id → resolver for correlation

// ── Connection ──
function toggleConnect() {
  if (ws && ws.readyState <= 1) disconnect();
  else connect();
}

function connect() {
  const url = document.getElementById('wsUrl').value.trim();
  if (!url) return;
  setDot('connecting');
  document.getElementById('connectBtn').textContent = 'Connecting…';
  document.getElementById('connectBtn').disabled = true;

  try {
    ws = new WebSocket(url);
  } catch(e) {
    setDot('error');
    addSysLog('error', 'Invalid URL: ' + e.message);
    resetConnBtn();
    return;
  }

  ws.onopen = () => {
    setDot('connected');
    document.getElementById('connectBtn').textContent = 'Disconnect';
    document.getElementById('connectBtn').disabled = false;
    addSysLog('connected', 'Connected to ' + url);
    sendList(true);
  };

  ws.onmessage = (evt) => {
    let msg;
    try { msg = JSON.parse(evt.data); }
    catch(e) { addRxLog('?', evt.data); return; }
    handleIncoming(msg);
  };

  ws.onerror = (e) => {
    setDot('error');
    addSysLog('error', 'WebSocket error — check server and CORS');
  };

  ws.onclose = (e) => {
    setDot('');
    addSysLog('disconnected', `Connection closed (code ${e.code})`);
    resetConnBtn();
    ws = null;
  };
}

function disconnect() {
  if (ws) ws.close();
}

function resetConnBtn() {
  const btn = document.getElementById('connectBtn');
  btn.textContent = 'Connect';
  btn.disabled = false;
}

// ── Incoming message handler ──
function handleIncoming(msg) {
  msgCount++;
  document.getElementById('msgCount').textContent = msgCount;
  document.getElementById('lastMsg').textContent = 'Last: ' + new Date().toLocaleTimeString();

  // Resolve pending request by id
  if (msg.id && pendingRequests[msg.id]) {
    pendingRequests[msg.id](msg);
    delete pendingRequests[msg.id];
  }

  switch (msg.type) {
    case 'tasks':
      handleTasks(msg);
      break;
    case 'started':
    case 'exited':
    case 'restarting':
    case 'errored':
    case 'error':
      addRxLog(msg.type, msg);
      // Update task state partially
      if (msg.task_id && tasks[msg.task_id]) {
        if (msg.type === 'started') tasks[msg.task_id].worker_state = 'running';
        if (msg.type === 'exited')  tasks[msg.task_id].worker_state = 'exited';
        if (msg.type === 'errored') tasks[msg.task_id].state = 'errored';
      }
      renderTasks();
      break;
    case 'output':
      addOutputLog(msg);
      break;
    default:
      addRxLog(msg.type || '?', msg);
  }
}

function handleTasks(msg) {
  // Merge into tasks map
  if (Array.isArray(msg.tasks)) {
    tasks = {};
    msg.tasks.forEach(t => { tasks[t.task_id] = t; });
  }
  renderTasks();
  addRxLog('tasks', { count: Object.keys(tasks).length, id: msg.id });
}

// ── Send helpers ──
function nextId() { return 'r' + (++reqId); }

function send(obj) {
  if (!ws || ws.readyState !== 1) {
    addSysLog('error', 'Not connected');
    return null;
  }
  const payload = JSON.stringify(obj);
  ws.send(payload);
  sentCount++;
  document.getElementById('sentCount').textContent = sentCount;
  addTxLog(obj.type, obj);
  return obj.id;
}

function sendWithId(obj) {
  obj.id = nextId();
  return send(obj);
}

function parseArgs(raw) {
  // Simple shell-like arg split: respects "double quoted" groups
  const args = [];
  let cur = '';
  let inq = false;
  for (let i = 0; i < raw.length; i++) {
    const c = raw[i];
    if (c === '"' && (i === 0 || raw[i-1] !== '\\')) { inq = !inq; continue; }
    if (c === ' ' && !inq) {
      if (cur) { args.push(cur); cur = ''; }
    } else {
      cur += c;
    }
  }
  if (cur) args.push(cur);
  return args;
}

function sendStart() {
  const taskId  = document.getElementById('start-taskid').value.trim();
  const command = document.getElementById('start-command').value.trim();
  const argsRaw = document.getElementById('start-args').value.trim();
  const rDelay  = document.getElementById('start-restart-delay').value.trim();
  const rWindow = document.getElementById('start-error-window').value.trim();
  const rThresh = document.getElementById('start-error-threshold').value.trim();

  const msg = { type: 'start', id: nextId() };
  if (taskId)  msg.task_id = taskId;
  if (command) msg.command  = command;
  if (argsRaw) msg.args    = parseArgs(argsRaw);

  if (rDelay || rWindow || rThresh) {
    msg.retry_policy = {};
    if (rDelay)  msg.retry_policy.restart_delay   = rDelay;
    if (rWindow) msg.retry_policy.error_window    = rWindow;
    if (rThresh) msg.retry_policy.error_threshold = parseInt(rThresh, 10);
  }

  send(msg);
  document.getElementById('start-hint').textContent = 'Sent id=' + msg.id;
}

function sendList(refresh) {
  const since = document.getElementById('list-since').value.trim();
  const msg = { type: 'list', id: nextId() };
  if (since) msg.since = since;
  if (refresh) pendingRequests[msg.id] = handleTasks;
  send(msg);
}

function sendStop() {
  const id = document.getElementById('stop-taskid').value.trim();
  if (!id) { addSysLog('error', 'task_id is required for stop'); return; }
  send({ type: 'stop', task_id: id, id: nextId() });
}

function sendReset() {
  const id = document.getElementById('reset-taskid').value.trim();
  if (!id) { addSysLog('error', 'task_id is required for reset'); return; }
  send({ type: 'reset', task_id: id, id: nextId() });
}

function sendReplay() {
  const id    = document.getElementById('replay-taskid').value.trim();
  const since = document.getElementById('replay-since').value.trim();
  if (!id) { addSysLog('error', 'task_id is required for replay'); return; }
  const msg = { type: 'replay', task_id: id, id: nextId() };
  if (since) msg.since = since;
  send(msg);
}

function sendRaw() {
  const raw = document.getElementById('rawMsg').value.trim();
  if (!raw) return;
  let obj;
  try { obj = JSON.parse(raw); }
  catch(e) { addSysLog('error', 'Invalid JSON: ' + e.message); return; }
  send(obj);
}

function formatRaw() {
  const ta = document.getElementById('rawMsg');
  try {
    ta.value = JSON.stringify(JSON.parse(ta.value), null, 2);
  } catch(e) { /* leave as-is */ }
}

function loadPreset(name) {
  const presets = {
    'list': { type: 'list' },
    'start-echo': {
      type: 'start',
      command: '/bin/sh',
      args: ['-c', 'while true; do date; sleep 2; done']
    },
    'start-retry': {
      type: 'start',
      command: '/bin/sh',
      args: ['-c', 'echo starting; sleep 1; exit 1'],
      retry_policy: { restart_delay: '3s', error_window: '30s', error_threshold: 5 }
    }
  };
  if (presets[name]) {
    document.getElementById('rawMsg').value = JSON.stringify(presets[name], null, 2);
    switchTab('raw');
  }
}

// ── Tasks UI ──
function renderTasks() {
  const list = Object.values(tasks);
  const count = list.length;
  document.getElementById('taskCount').textContent = count ? `(${count})` : '';
  document.getElementById('taskCountStatus').textContent = count;

  const el = document.getElementById('tasksList');
  if (!count) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">No tasks.</div>';
    return;
  }

  // Sort by created_at desc
  list.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  el.innerHTML = list.map(t => {
    const cmd = [t.command, ...(t.args||[])].join(' ');
    const state = t.state || 'active';
    const worker = t.worker_state || '';
    return `
      <div class="task-card">
        <div class="task-card-top">
          <span class="task-state ${state}">${state}</span>
          ${worker ? `<span style="font-size:10px;color:var(--muted)">${worker}</span>` : ''}
          <span class="task-cmd" title="${escHtml(cmd)}">${escHtml(cmd)}</span>
        </div>
        <div class="task-id">${t.task_id}</div>
        ${t.current_pid ? `<div class="hint">PID ${t.current_pid}  ·  restarts: ${t.restart_count}</div>` : ''}
        <div class="task-actions">
          <button class="secondary" onclick="fillTaskId('${t.task_id}')">Use ID</button>
          <button class="secondary" onclick="sendReplayFor('${t.task_id}')">Replay</button>
          ${state !== 'stopped' ? `<button class="danger" onclick="sendStopFor('${t.task_id}')">Stop</button>` : ''}
          ${state === 'errored' ? `<button onclick="sendResetFor('${t.task_id}')">Reset</button>` : ''}
        </div>
      </div>`;
  }).join('');
}

function clearTasks() { tasks = {}; renderTasks(); }

function fillTaskId(id) {
  ['stop','reset','replay'].forEach(f => {
    document.getElementById(f+'-taskid').value = id;
  });
  addSysLog('info', 'Filled task_id: ' + id);
}

function sendStopFor(id)   { send({ type:'stop',   task_id: id, id: nextId() }); }
function sendResetFor(id)  { send({ type:'reset',  task_id: id, id: nextId() }); }
function sendReplayFor(id) { send({ type:'replay', task_id: id, id: nextId() }); }

// ── Log rendering ──
function getLogEl() {
  const log = document.getElementById('log');
  if (logEmpty) {
    log.innerHTML = '';
    logEmpty = false;
  }
  return log;
}

function addLogEntry(dir, type, bodyHtml) {
  const log = getLogEl();
  const ts = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

  // Determine filter category
  let filterCat = type;
  if (!['output','started','exited','tasks','error'].includes(type)) filterCat = 'other';

  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.dataset.filter = filterCat;
  if (!activeFilters.has(filterCat)) entry.classList.add('hidden');

  entry.innerHTML =
    `<span class="log-ts">${ts}</span>` +
    `<span class="log-dir ${dir}">${dir.toUpperCase()}</span>` +
    `<span class="log-type">${escHtml(type)}</span>` +
    `<span class="log-body">${bodyHtml}</span>`;

  log.appendChild(entry);

  if (document.getElementById('autoScroll').checked) {
    log.scrollTop = log.scrollHeight;
  }
}

function addTxLog(type, obj) {
  const body = `<span style="color:var(--muted)">${escHtml(JSON.stringify(obj))}</span>`;
  addLogEntry('tx', type, body);
}

function addRxLog(type, obj) {
  let body;
  if (type === 'tasks') {
    body = `<span style="color:var(--muted)">received ${obj.count} task(s)` +
           (obj.id ? ` <span class="task-id-ref">[id=${obj.id}]</span>` : '') + '</span>';
  } else if (type === 'started') {
    body = `<span class="task-id-ref">${obj.task_id}</span>` +
           ` <span class="pid-ref">pid=${obj.pid}</span>` +
           (obj.restart_of ? ` restart_of=${obj.restart_of}` : '');
  } else if (type === 'exited') {
    const ok = obj.exit_code === 0;
    const color = ok ? 'var(--green)' : 'var(--red)';
    body = `<span class="task-id-ref">${obj.task_id}</span>` +
           ` <span class="pid-ref">pid=${obj.pid}</span>` +
           ` exit=<span style="color:${color}">${obj.exit_code}</span>` +
           (obj.intentional ? ' <span style="color:var(--muted)">(intentional)</span>' : '');
  } else if (type === 'restarting') {
    body = `<span class="task-id-ref">${obj.task_id}</span>` +
           ` attempt=${obj.attempt} delay=${obj.restart_delay}`;
  } else if (type === 'errored') {
    body = `<span class="task-id-ref">${obj.task_id}</span>` +
           ` <span style="color:var(--red)">exit_count=${obj.exit_count}</span>`;
  } else if (type === 'error') {
    body = `<span style="color:var(--red)">${escHtml(obj.message)}</span>` +
           (obj.id ? ` <span class="task-id-ref">[id=${obj.id}]</span>` : '');
  } else {
    body = `<span style="color:var(--muted)">${escHtml(JSON.stringify(obj))}</span>`;
  }
  addLogEntry('rx', type, body);
}

function addOutputLog(msg) {
  const cls = msg.stream === 'stderr' ? 'stderr' : '';
  const body = `<span class="task-id-ref">${msg.task_id}</span>` +
               ` <span class="pid-ref">pid=${msg.pid}</span> ` +
               `<span class="output-data ${cls}">${escHtml(msg.data)}</span>`;
  addLogEntry('rx', 'output', body);
}

function addSysLog(subtype, msg) {
  const colors = { connected:'var(--green)', disconnected:'var(--muted)', error:'var(--red)', info:'var(--accent)' };
  const color = colors[subtype] || 'var(--text)';
  addLogEntry('sys', subtype, `<span style="color:${color}">${escHtml(msg)}</span>`);
}

function clearLog() {
  const log = document.getElementById('log');
  log.innerHTML = '';
  logEmpty = true;
  msgCount = 0; sentCount = 0;
  document.getElementById('msgCount').textContent = 0;
  document.getElementById('sentCount').textContent = 0;
}

// ── Filters ──
function toggleFilter(chip) {
  const type = chip.dataset.type;
  if (chip.classList.toggle('on')) {
    activeFilters.add(type);
  } else {
    activeFilters.delete(type);
  }
  document.querySelectorAll(`.log-entry[data-filter="${type}"]`).forEach(el => {
    el.classList.toggle('hidden', !activeFilters.has(type));
  });
}

// ── UI helpers ──
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['operations','tasks','raw'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.tab-content').forEach(tc => {
    tc.classList.toggle('active', tc.id === 'tab-' + name);
  });
}

function toggleCard(id) {
  document.getElementById(id).classList.toggle('expanded');
}

function setDot(state) {
  const dot = document.getElementById('dot');
  dot.className = 'dot' + (state ? ' ' + state : '');
}

function escHtml(s) {
  if (typeof s !== 'string') s = String(s);
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
