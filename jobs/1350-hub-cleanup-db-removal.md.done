---
title: Remove task DB persistence from hub.go, remove all legacy/dead code
created: 2026-02-21
origin: Owner directive — no crash recovery, no DB persistence for tasks. Start fresh on restart. Also remove handleStartLegacy, newHandler, wsUpgrader dead code.
priority: high
complexity: high
notes:
  - This is major surgery affecting hub.go, store.go, and main.go
  - Exit history will be re-implemented in job 1370 using optional DB
  - All DB calls for task CRUD will be removed from the critical path
  - Tests must pass without DB dependency after completion
  - handleStartLegacy removal means no legacy fallback; all tests updated
---

Follow exactly and without stopping:

## Task: Remove task DB persistence and dead code from sticky-overseer

## Background & Context

The owner has mandated that sticky-overseer should NOT persist task state across restarts. The original architecture included SQLite persistence for crash recovery and task history, but the new design philosophy is: start fresh on every restart. This means:

1. No tasks table in SQLite
2. No task CRUD operations (createTask, updateTaskState, updateTaskStats, updateTaskExitTimestamps, listTasks, getTask, deleteTask)
3. No DB loading on startup (hub.newHub currently loads persisted tasks)
4. No DB updates on every task lifecycle event

Additionally, three pieces of dead code remain from earlier iterations:
- handleStartLegacy: fallback for when no Actions map is configured (tests were updated to always provide Actions)
- newHandler function: HTTP upgrade handler that is no longer called (transport.go owns this now)
- wsUpgrader package-level variable: gorilla/websocket upgrader used by newHandler

Future work (job 1370) will re-implement exit history persistence using an optional DB handle (hubConfig.DB), but this job removes ALL current task CRUD operations.

## Problem Description

Current state:
- hub.go calls createTask(h.db, ...) on line ~417 every time a task starts
- hub.go calls updateTaskState(h.db, ...) on lines ~77, 435, 558, 661, 700, 939, 1031 for state changes
- hub.go calls updateTaskStats(h.db, ...) on lines ~559, 701, 736, 906, 932, 1006 for exit/restart tracking
- hub.go calls updateTaskExitTimestamps(h.db, ...) on lines ~702, 933 for exit history
- hub.go startup (newHub, lines ~69-83) loads all tasks from DB and marks active ones as stopped
- store.go contains full CRUD implementation for tasks that is never called after job 1350
- handleStartLegacy (lines ~491-566) is dead code — hub_test.go tests were already updated
- newHandler (lines ~152-168) and wsUpgrader (lines ~20-22) are dead code — transport.go handles HTTP upgrade
- main.go opens DB (line 89) and passes it to hubConfig (line 147) even though it's unused after this job

## Implementation Plan

### Task 1: Remove DB calls from hub.go

1. Search hub.go for all createTask, updateTaskState, updateTaskStats, updateTaskExitTimestamps calls:
   - Remove `if h.db != nil { createTask(...) }` block on line ~417
   - Remove `if h.db != nil { updateTaskState(...) }` calls on lines ~435, 558, 661, 700, 939, 1031
   - Remove `if h.db != nil { updateTaskStats(...) }` calls on lines ~559, 701, 736, 906, 932, 1006
   - Remove `if h.db != nil { updateTaskExitTimestamps(...) }` calls on lines ~702, 933
   - Remove the entire DB loading loop in newHub (lines ~68-83)

2. Remove `h.db` field from Hub struct (line 46)

3. Remove `DB` field from hubConfig struct (line 26)

### Task 2: Remove handleStartLegacy function

1. Locate handleStartLegacy function (lines ~491-566 in hub.go)
2. Delete the entire function
3. In handleStart function (line ~351), remove the guard:
   ```
   if h.actions == nil {
       h.handleStartLegacy(conn, msg)
       return
   }
   ```
4. Replace with error handling: if h.actions is nil, return error to client

### Task 3: Remove dead code from hub.go

1. Remove wsUpgrader package-level variable (lines ~20-22)
2. Remove newHandler function (lines ~152-168)
3. Verify no other references to newHandler exist in the codebase (should be none — transport.go replaced it)

### Task 4: Simplify store.go

1. Remove all task-related CRUD functions:
   - createTask (lines ~161-183)
   - getTask (lines ~185-190)
   - listTasks (lines ~192-209)
   - updateTaskState (lines ~211-215)
   - updateTaskStats (lines ~217-230)
   - updateTaskExitTimestamps (lines ~232-236)
   - deleteTask (lines ~238-241)
   - scanTaskRow (lines ~274-315)

2. Remove migration function:
   - migrateV2toV3 (lines ~112-159)

3. Remove TaskRecord struct (lines ~20-33) — this is embedded in hub.Task and no longer persisted

4. Simplify openDB():
   - Remove tasks table creation (lines ~91-107)
   - Remove schema versioning logic (lines ~66-89 can be simplified)
   - Keep only: WAL mode setup, busy timeout PRAGMA
   - Decide: Keep schema_version table (no), or remove versioning entirely (yes, per owner intent)

5. Remove helper functions:
   - encodeTimestamps (lines ~243-251)
   - decodeTimestamps (lines ~253-267)
   - scanner interface (lines ~269-272)

6. Update store.go to be minimal:
   ```go
   package main

   import (
       "database/sql"
       "fmt"
       _ "modernc.org/sqlite"
   )

   // openDB opens the SQLite database and configures WAL mode + busy timeout.
   // Pass ":memory:" for in-memory (used in tests).
   func openDB(path string) (*sql.DB, error) {
       db, err := sql.Open("sqlite", path)
       if err != nil {
           return nil, err
       }

       for _, pragma := range []string{
           `PRAGMA journal_mode=WAL`,
           `PRAGMA busy_timeout=5000`,
       } {
           if _, err := db.Exec(pragma); err != nil {
               db.Close()
               return nil, fmt.Errorf("overseer: failed to set pragma %q: %w", pragma, err)
           }
       }

       return db, nil
   }
   ```

### Task 5: Update main.go

1. Keep the `db, err := openDB(cfg.DB)` call on line ~89 (needed for future exit_history work)
2. Pass db to hubConfig on line ~147 (keep DB field in hubConfig as optional *sql.DB for future use)
3. Keep defer db.Close() on line ~94

Note: hubConfig.DB can be left as-is and will be nil-checked in future jobs. For now, just ensure hub.go doesn't try to use it for task CRUD.

### Task 6: Update hub.go to keep hubConfig.DB optional

1. In hubConfig struct, keep DB field but add a comment explaining it's reserved for exit_history persistence (job 1370)
2. In newHub constructor, remove all logic that uses h.db — don't read tasks on startup, don't mark them stopped
3. Leave h.db assignment but ensure no code paths use it for task operations
4. Anywhere h.db was checked before DB operations, remove those checks (no more createTask/updateTaskState/etc)

### Task 7: Verify tests still pass

1. Run: go build ./...
   - Should compile without errors
   
2. Run: go test -race ./...
   - All tests should pass
   - hub_test.go tests use :memory: database which will still work (just no schema inside)
   - Tests never relied on task persistence — they all start fresh in each test
   - If any test breaks, it was relying on startup DB loading (old behavior that should fail now)

## Technical Requirements

- File paths:
  - /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/hub.go (main surgery)
  - /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/store.go (gutted)
  - /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/main.go (minimal changes)
  - /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/hub_test.go (verify, don't modify unless tests break)

- Commands to verify:
  - go build ./...
  - go test -race ./...
  - cd /home/mmulligan/Development/whisper-darkly-github/sticky-overseer && go vet ./...

- Reference: CLAUDE.md in the project root explains architecture and build steps

## Success Criteria

1. hub.go compiles without references to createTask, updateTaskState, updateTaskStats, updateTaskExitTimestamps
2. hub.go contains no wsUpgrader or newHandler code
3. hub.go contains no handleStartLegacy function
4. store.go contains only openDB() and minimal pragma setup (no task CRUD, no migration, no TaskRecord, no timestamps helpers)
5. go build ./... passes
6. go test -race ./... passes with all tests green
7. go vet ./... passes with no warnings
8. grep -n "createTask\|updateTaskState\|updateTaskStats\|updateTaskExitTimestamps" hub.go returns no results
9. grep -n "handleStartLegacy\|newHandler\|wsUpgrader" hub.go returns no results
10. hubConfig still has DB *sql.DB field (for future exit_history work) but it's not used in task operations

## Expected Outcome

When this job completes:

1. Hub starts with no database loaded — tasks map is empty on startup
2. Tasks are created in memory only and discarded on shutdown
3. No DB persistence layer for task state
4. No legacy fallback code paths (handleStartLegacy removed)
5. No dead HTTP upgrade code (newHandler/wsUpgrader removed)
6. store.go is a minimal database utility for future exit_history persistence
7. All tests pass without DB-dependent behavior
8. Future job 1370 can add exit history persistence using the reserved hubConfig.DB field

## Reference Information

- Current hub.go: /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/hub.go
  - Lines ~20-22: wsUpgrader variable
  - Lines ~46: h.db field in Hub struct
  - Lines ~68-83: newHub DB loading and startup logic
  - Lines ~152-168: newHandler function
  - Lines ~417-420: createTask DB call in handleStart
  - Lines ~435-436: updateTaskState DB call in handleStart error case
  - Lines ~491-566: handleStartLegacy entire function
  - Lines ~558-560: updateTaskState/updateTaskStats DB calls in handleStartLegacy
  - Lines ~661-662: updateTaskState DB call in handleStop
  - Lines ~700-702: updateTaskState/updateTaskStats/updateTaskExitTimestamps DB calls in handleReset
  - Lines ~905-907: updateTaskStats DB call in onWorkerExited
  - Lines ~931-933: updateTaskStats/updateTaskExitTimestamps DB calls in onWorkerExited
  - Lines ~939-940: updateTaskState DB call in onWorkerExited (errored state)
  - Lines ~1005-1006: updateTaskStats DB call in doRestart
  - Lines ~1030-1031: updateTaskState DB call in stopWorker

- Current store.go: /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/store.go
  - Lines ~20-33: TaskRecord struct (remove)
  - Lines ~66-89: Schema version check and migration logic (simplify)
  - Lines ~91-107: Tasks table creation (remove)
  - Lines ~112-159: migrateV2toV3 function (remove)
  - Lines ~161-241: All task CRUD functions (remove)
  - Lines ~243-315: Helper functions for timestamps/scanning (remove)

- Current main.go: /home/mmulligan/Development/whisper-darkly-github/sticky-overseer/main.go
  - Line ~89: db, err := openDB(cfg.DB)
  - Line ~147: DB: db in hubConfig
  - These stay as-is for now

## Notes & Warnings

1. After this job, sticky-overseer loses crash recovery for tasks. This is intentional per owner directive.
2. Do NOT remove the hubConfig.DB field — future job 1370 needs it for exit_history persistence.
3. Do NOT create a new database schema version — just remove versioning entirely (owner intent).
4. If hub_test.go breaks because it relies on DB behavior, update the test setup (newHubEnv) to not expect task loading.
5. The DB is still opened in main.go for future use — that's fine. Just don't use it for tasks in hub.go.
6. Be careful with line number references — they may have shifted during development. Use grep patterns instead of exact line numbers when possible.
7. After removing handleStartLegacy, all tests must provide a valid Actions map when creating a hub. The old hub_test.go already does this (newHubEnv passes defaultTestActions), so tests should pass.
8. Consider running the build and tests multiple times during the process to catch errors early.
